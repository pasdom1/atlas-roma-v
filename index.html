<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=yes">
<title>Mappa Interattiva</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
  }
  #map {
    width: 100%;
    height: 100%;
    background: black;
  }

  /* ðŸ“Œ Legenda molto piÃ¹ grande e cliccabile per cellulari */
  .legend {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 20000;
    background: rgba(255,255,255,0.93);
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    box-shadow: 0 0 8px rgba(0,0,0,0.4);
    touch-action: manipulation;
  }

  .legend span {
    display: block;
    padding: 8px 0;
    margin-top: 4px;
    border-radius: 5px;
  }

  /* ðŸ”¥ Quando un layer Ã¨ attivo â†’ evidenziarlo */
  .active-layer {
    background: rgba(0,150,255,0.30);
    border-left: 4px solid #0078ff;
  }

  .legend span:hover {
    background: rgba(0,0,0,0.08);
  }
</style>
</head>

<body>

<div id="map"></div>

<!-- ðŸ“Œ Legenda touch-friendly -->
<div class="legend" id="legendBox">
  <b>Filtri</b>
  <span id="legE"></span>
  <span id="legI"></span>
  <span id="legM"></span>
</div>

<!-- ðŸ“Œ Dati -->
<script src="./js/data.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

// --------------------------------------------------
// Mappa raster
// --------------------------------------------------
const imgWidth = 3509;
const imgHeight = 2482;
const bounds = [[0,0],[imgHeight,imgWidth]];

const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -4,
  maxZoom: 4,
  zoomControl: true,
  attributionControl: false
});

L.imageOverlay('./assets/mappa.png', bounds).addTo(map);

/* ðŸ“Œ Zoom iniziale ottimizzato per smartphone */
function setInitialView() {
  const zoom = map.getBoundsZoom(bounds, true) - 1.2;
  map.setView([250,250], zoom);
}
setInitialView();

map.setMaxBounds(bounds);

// --------------------------------------------------
// Trasformazione LAT/LON -> PIXEL
// --------------------------------------------------
function latLonToPixel(lat, lon) {
  const x = 54528.2708239365 * lon 
          - 5264.35641131556 * lat 
          - 462269.595382222;
  const y = 22853.1955817737 * lon 
          + 38484.5147246228 * lat 
          - 1897326.38061588;
  return [y, x];
}

// --------------------------------------------------
// Icone â€” molto piccole allo zoom minimo
// --------------------------------------------------
let allMarkers = [];

const iconURLs = [
  './assets/icons/icon1.png',
  './assets/icons/icon2.png',
  './assets/icons/icon3.png'
];

function getIcon(iconUrl, zoom) {
  const base = 12; // Ancora piÃ¹ piccole di prima
  const scale = Math.max(0.45, zoom * 0.18);
  const size = base * scale;
  return L.icon({
    iconUrl,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2]
  });
}

map.on("zoomend", () => {
  const zoom = map.getZoom();
  allMarkers.forEach(m=>{
    m.marker.setIcon(getIcon(m.iconUrl, zoom));
  });
});

// --------------------------------------------------
// Layers dataset
// --------------------------------------------------
const groupE = L.layerGroup();
const groupI = L.layerGroup();
const groupM = L.layerGroup();

const datasets = [
  { group: groupE, data: DATA_E, icon: iconURLs[0], legId:"legE", legName:"EsternalitÃ " },
  { group: groupI, data: DATA_I, icon: iconURLs[1], legId:"legI", legName:"InterioritÃ " },
  { group: groupM, data: DATA_M, icon: iconURLs[2], legId:"legM", legName:"Matrice" }
];

// --------------------------------------------------
// Preparo marker MA NON li aggiungo ancora
// --------------------------------------------------
datasets.forEach(ds => {
  ds.data.forEach(p=>{
    const [y,x]=latLonToPixel(p.lat,p.lon);
    const m=L.marker([y,x],{
      icon:getIcon(ds.icon,map.getZoom())
    }).bindPopup(`<b>${p.name}</b><br>${p.type}`);

    ds.group.addLayer(m);
    allMarkers.push({marker:m,iconUrl:ds.icon});
  });
});

// --------------------------------------------------
// Legenda click per mostrare/nascondere
// --------------------------------------------------
let activeLayer = null;

function renderLegend() {
  datasets.forEach(ds=>{
    const el=document.getElementById(ds.legId);
    el.innerHTML=`<img src="${ds.icon}" width="20"> ${ds.legName} (${ds.data.length})`;
    el.classList.remove("active-layer");
  });
  if(activeLayer){
    document.getElementById(activeLayer.legId).classList.add("active-layer");
  }
}

datasets.forEach(ds=>{
  document.getElementById(ds.legId).addEventListener("click", ()=>{

    document.querySelectorAll(".legend span").forEach(span=>{
      span.classList.remove("active-layer");
    });

    if(activeLayer===ds){
      datasets.forEach(l=>map.removeLayer(l.group));
      activeLayer=null;
    } else {
      datasets.forEach(l=>map.removeLayer(l.group));
      map.addLayer(ds.group);
      activeLayer=ds;
    }

    renderLegend();
  });
});

renderLegend();

</script>
</body>
</html>
