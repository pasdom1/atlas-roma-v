<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=yes">
<title>Mappa Interattiva</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
  }
  #map {
    width: 100%;
    height: 100%;
    background: black;
  }
  .legend {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10000;
    background: rgba(255,255,255,0.90);
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
  }
  .legend span {
    display: block;
    padding: 3px 0;
  }
</style>
</head>

<body>

<div id="map"></div>

<div class="legend" id="legendBox">
  <b>Legenda (tocca per mostrare)</b><br>
  <span id="legE"></span>
  <span id="legI"></span>
  <span id="legM"></span>
</div>

<script src="./js/data.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

// --------------------------------------------------
// MAPPA RASTER
// --------------------------------------------------
const imgWidth = 3509;
const imgHeight = 2482;
const bounds = [[0,0],[imgHeight,imgWidth]];

const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -3,
  maxZoom: 4,
  zoomControl: true,
  attributionControl: false
});

L.imageOverlay('./assets/mappa.png', bounds).addTo(map);
map.setView([100,100], -1);
map.setMaxBounds(bounds);


// --------------------------------------------------
// TRASFORMAZIONE LAT/LON → PIXEL
// --------------------------------------------------
function latLonToPixel(lat, lon) {
  const x = 54528.2708239365 * lon 
          - 5264.35641131556 * lat 
          - 462269.595382222;

  const y = 22853.1955817737 * lon 
          + 38484.5147246228 * lat 
          - 1897326.38061588;

  return [y, x];
}


// --------------------------------------------------
// ICONE MOLTO PICCOLE ALLO ZOOM MINIMO
// --------------------------------------------------
let allMarkers = [];

const iconURLs = [
  './assets/icons/icon1.png',
  './assets/icons/icon2.png',
  './assets/icons/icon3.png'
];

function getIcon(iconUrl, zoom) {
  const base = 14; // ICONA SUPER PICCOLA ALL'INIZIO
  const scale = Math.max(0.45, zoom * 0.18);
  const size = base * scale;

  return L.icon({
    iconUrl,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2]
  });
}

map.on("zoomend", () => {
  const zoom = map.getZoom();
  allMarkers.forEach(m => {
    m.marker.setIcon(getIcon(m.iconUrl, zoom));
  });
});


// --------------------------------------------------
// LAYERS (vuoti all'inizio)
// --------------------------------------------------
const groupE = L.layerGroup();
const groupI = L.layerGroup();
const groupM = L.layerGroup();

const datasets = [
  { group: groupE, data: DATA_E, icon: iconURLs[0], legId:"legE", legName:"Esternalità" },
  { group: groupI, data: DATA_I, icon: iconURLs[1], legId:"legI", legName:"Interiorità" },
  { group: groupM, data: DATA_M, icon: iconURLs[2], legId:"legM", legName:"Matrice" }
];


// --------------------------------------------------
// CREA MARKER (ma NON li aggiunge ancora)
// --------------------------------------------------
datasets.forEach(ds => {
  ds.data.forEach(p => {
    const [y,x] = latLonToPixel(p.lat, p.lon);

    const marker = L.marker([y,x], {
      icon: getIcon(ds.icon, map.getZoom())
    }).bindPopup(`<b>${p.name}</b><br>${p.type}`);

    ds.group.addLayer(marker);
    allMarkers.push({ marker, iconUrl: ds.icon });
  });
});


// --------------------------------------------------
// LEGENDA INTERATTIVA (mostra/nasconde layer)
// --------------------------------------------------
let activeLayer = null;

function refreshLegend() {
  datasets.forEach(ds => {
    document.getElementById(ds.legId).innerHTML =
      `<img src="${ds.icon}" width="12"> ${ds.legName}: ${ds.data.length}`;
  });
}

function setupLegendClick() {
  datasets.forEach(ds => {
    document.getElementById(ds.legId).addEventListener("click", () => {

      if (activeLayer === ds) {
        // Nascondi tutti
        datasets.forEach(d => map.removeLayer(d.group));
        activeLayer = null;
      } else {
        // Mostra SOLO questo
        datasets.forEach(d => map.removeLayer(d.group));
        map.addLayer(ds.group);
        activeLayer = ds;
      }

    });
  });
}

refreshLegend();
setupLegendClick();

</script>
</body>
</html>
