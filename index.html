<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=yes">
<title>Mappa Interattiva</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
  }
  #map {
    width: 100%;
    height: 100%;
    background: black;
  }

  /* ðŸ“Œ Legenda chiudibile */
  .legend {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 20000;
    background: rgba(255,255,255,0.95);
    padding: 8px 12px;
    border-radius: 12px;
    box-shadow: 0 0 8px rgba(0,0,0,0.4);
    font-size: 16px;
    transition: all 0.25s ease;
    overflow: hidden;
    touch-action: manipulation;
  }

  .legend.minimized {
    width: 45px;
    height: 45px;
    padding: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }

  .legend .title {
    font-weight: 700;
    margin-bottom: 8px;
    text-align: center;
    cursor: pointer;
  }

  .legend span {
    display: block;
    padding: 10px 0;
    border-radius: 6px;
    font-size: 15px;
  }

  .legend span:hover {
    background: rgba(0,0,0,0.10);
  }

  /* ðŸ”µ Layer attivo */
  .active-layer {
    background: rgba(0,150,255,0.25) !important;
    border-left: 4px solid #0099ff;
  }

</style>
</head>

<body>

<div id="map"></div>

<!-- ðŸ“Œ Legenda chiudibile -->
<div class="legend minimized" id="legendBox">
  <span class="title" id="legendToggle">â‰¡</span>
  <div id="legendItems" style="display:none;">
    <span id="legE"></span>
    <span id="legI"></span>
    <span id="legM"></span>
  </div>
</div>

<script src="./js/data.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

// --------------------------------------------------
// Mappa raster + zoom migliorato
// --------------------------------------------------
const imgWidth = 3509;
const imgHeight = 2482;
const bounds = [[0,0],[imgHeight,imgWidth]];

const map = L.map('map', { crs:L.CRS.Simple, minZoom:-4, maxZoom:4, attributionControl:false });
L.imageOverlay('./assets/mappa.png', bounds).addTo(map);

function setInitialView() {
  const zoom = map.getBoundsZoom(bounds, true) - 1.2;
  map.setView([250,250], zoom);
}
setInitialView();
map.setMaxBounds(bounds);


// --------------------------------------------------
// MATRICE (DATA_M + provvisoriamente DATA_I)
// MATRICE (DATA_M + usata temporaneamente anche prima)
function latLonToPixelM(lat, lon) {
  const x = 54528.2708239365 * lon
          - 5264.35641131556 * lat
          - 462269.595382222;
  const y = 22853.1955817737 * lon
          + 38484.5147246228 * lat
          - 1897326.38061588;
  return [y, x];
}

// ESTERIORITÃ€ (DATA_E) â€“ calcolata sui 3 punti di Tor Pignattara
function latLonToPixelE(lat, lon) {
  const x = 36074.8038237490 * lon
          + 5464.64772941134 * lat
          - 680415.881280752;
  const y = 1990.04543899633 * lon
          + 44143.5772521760 * lat
          - 1872939.22473998;
  return [y, x];
}

// INTERIORITÃ€ (DATA_I) â€“ calcolata sui 3 punti che mi hai dato ora
function latLonToPixelI(lat, lon) {
  const x = 34762.2354475593 * lon
          + 862.993582231959 * lat
          - 471239.918380728;
  const y = 7735.96296088214 * lon
          + 47995.7880433514 * lat
          - 2106343.71493314;
  return [y, x];
}


// --------------------------------------------------
let allMarkers = [];
const iconURLs = ['./assets/icons/icon1.png','./assets/icons/icon3.png','./assets/icons/icon2.png'];

function getIcon(iconUrl, zoom) {
  const base = 18; // grandezza naturale
  const scale = Math.max(0.45, zoom * 0.40); // cresce piÃ¹ velocemente
  const size = base * scale;

  return L.icon({
    iconUrl,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2]
  });
}

map.on("zoomend",()=>{
  const z=map.getZoom();
  allMarkers.forEach(m=>m.marker.setIcon(getIcon(m.iconUrl,z)));
});


// --------------------------------------------------
const groupE = L.layerGroup();
const groupI = L.layerGroup();
const groupM = L.layerGroup();

const datasets = [
  // EsterioritÃ  â†’ trasformatore dedicato E
  { group: groupE, data: DATA_E, icon: iconURLs[0], legId:"legE", legName:"EsternalitÃ ", transformer: latLonToPixelE },
  // InterioritÃ  â†’ trasformatore dedicato I
  { group: groupI, data: DATA_I, icon: iconURLs[1], legId:"legI", legName:"InterioritÃ ", transformer: latLonToPixelI },
  // Matrice â†’ trasformatore M
  { group: groupM, data: DATA_M, icon: iconURLs[2], legId:"legM", legName:"Matrice", transformer: latLonToPixelM }
];

datasets.forEach(ds=>{
  ds.data.forEach(p=>{
    const [y,x] = ds.transformer(p.lat, p.lon);
    const marker=L.marker([y,x],{ icon:getIcon(ds.icon,map.getZoom()) })
      .bindPopup(`<b>${p.name}</b>`);
    ds.group.addLayer(marker);
    allMarkers.push({marker,iconUrl:ds.icon});
  });
});


// --------------------
// Legenda logica
// --------------------
let activeLayer = null;

function renderLegend() {
  datasets.forEach(ds=>{
    const el=document.getElementById(ds.legId);
    el.innerHTML=`<img src="${ds.icon}" width="20"> ${ds.legName} (${ds.data.length})`;
    el.classList.remove("active-layer");
  });
  if(activeLayer){
    document.getElementById(activeLayer.legId).classList.add("active-layer");
  }
}

// Toggle legenda aperta/chiusa
document.getElementById("legendToggle").addEventListener("click", ()=> {
  const box=document.getElementById("legendBox");
  const items=document.getElementById("legendItems");

  if(box.classList.contains("minimized")){
    box.classList.remove("minimized");
    items.style.display="block";
    document.getElementById("legendToggle").innerHTML="Filtri";
  } else {
    box.classList.add("minimized");
    items.style.display="none";
    document.getElementById("legendToggle").innerHTML="â‰¡";
  }
});

// Click filtri
datasets.forEach(ds=>{
  document.getElementById(ds.legId).addEventListener("click",()=>{

    document.querySelectorAll(".legend span").forEach(s=>s.classList.remove("active-layer"));

    if(activeLayer===ds){
      // Nasconde tutti
      datasets.forEach(l=>map.removeLayer(l.group));
      activeLayer=null;
    } else {
      datasets.forEach(l=>map.removeLayer(l.group));
      map.addLayer(ds.group);
      activeLayer=ds;
    }

    renderLegend();
  });
});

renderLegend();

</script>
</body>
</html>
