<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Mappa Roma V - React</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

  <style>
    html, body {
      margin:0; padding:0;
      background:#000;
      height:100%;
      overflow:hidden;
      touch-action:none;
    }
    #root {
      height:100vh;
      width:100vw;
      overflow:hidden;
    }
    img {
      will-change: transform;
      transform-origin: center center;
      object-fit: cover;
      width:100%;
      height:100%;
    }
  </style>
</head>
<body>

<div id="root"></div>

<!-- React CDN -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<script>
const { useRef, useEffect } = React;

function App() {
  const imgRef = useRef(null);

  let scale = 1, lastScale = 1;
  let posX = 0, posY = 0, lastPosX = 0, lastPosY = 0;
  let startX = 0, startY = 0, startDistance = 0;
  let lastTap = 0;

  const dist = (ev) =>
    Math.hypot(
      ev.touches[0].pageX - ev.touches[1].pageX,
      ev.touches[0].pageY - ev.touches[1].pageY
    );

  const update = () => {
    imgRef.current.style.transform =
      `translate(${posX}px, ${posY}px) scale(${scale})`;
  };

  const handleStart = (ev) => {
    if (ev.touches.length === 2) {
      startDistance = dist(ev);
    } else {
      startX = ev.touches[0].pageX - lastPosX;
      startY = ev.touches[0].pageY - lastPosY;
    }
  };

  const handleMove = (ev) => {
    ev.preventDefault();

    if (ev.touches.length === 2) {
      const newDist = dist(ev);
      scale = Math.min(5, Math.max(1, lastScale * (newDist / startDistance)));
    }

    if (ev.touches.length === 1 && scale > 1) {
      posX = ev.touches[0].pageX - startX;
      posY = ev.touches[0].pageY - startY;
    }

    update();
  };

  const handleEnd = () => {
    lastScale = scale;

    if (scale <= 1.02) {
      scale = 1;
      posX = posY = lastPosX = lastPosY = 0;
    } else {
      lastPosX = posX;
      lastPosY = posY;
    }
    update();
  };

  const handleTap = () => {
    const now = Date.now();
    if (now - lastTap < 300) {
      if (scale > 1) {
        scale = lastScale = 1;
        posX = posY = lastPosX = lastPosY = 0;
      } else {
        scale = lastScale = 2;
      }
      update();
    }
    lastTap = now;
  };

  useEffect(() => {
    const img = imgRef.current;
    img.addEventListener('touchstart', handleStart);
    img.addEventListener('touchmove', handleMove);
    img.addEventListener('touchend', handleEnd);
    img.addEventListener('touchend', handleTap);
    return () => {
      img.removeEventListener('touchstart', handleStart);
      img.removeEventListener('touchmove', handleMove);
      img.removeEventListener('touchend', handleEnd);
      img.removeEventListener('touchend', handleTap);
    };
  }, []);

  return React.createElement("img", {
    ref: imgRef,
    src: "./assets/mappa.png"
  });
}

ReactDOM.createRoot(document.getElementById('root')).render(
  React.createElement(App)
);
</script>

</body>
</html>
